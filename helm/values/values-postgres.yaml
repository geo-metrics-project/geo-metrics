primary:
  persistence:
    enabled: true
    size: 2Gi
    # storageClass: ""  # Uncomment and set if you need a specific StorageClass
  
  # Resource limits and requests
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Pod disruption budget
  podDisruptionBudget:
    enabled: true
    minAvailable: 1
  
  # PostgreSQL image configuration
  image:
    repository: registry-1.docker.io/bitnami/postgresql
    tag: "16.4.0-debian-12-r20"
    pullPolicy: IfNotPresent
  
  # Extra environment variables
  extraEnvVars:
    - name: POSTGRESQL_LOG_TIMEZONE
      value: "UTC"
    - name: TZ
      value: "UTC"

  initdb:
    scripts:
      init.sql: |
        -- Database initialization for GEO-Metrics
        -- User and database are created automatically by Bitnami Helm chart
        -- This script only creates tables and indexes
        
        -- Reports table (user_id references Ory Kratos identity)
        CREATE TABLE IF NOT EXISTS reports (
            id SERIAL PRIMARY KEY,
            brand_name VARCHAR(255) NOT NULL,
            competitor_names TEXT[],
            user_id VARCHAR(255) NOT NULL,  -- Kratos UUID
            owner_email VARCHAR(255) NOT NULL,  -- Owner's email from Kratos
            
            -- Flexible KPI storage (add/remove metrics without schema changes)
            kpis JSONB DEFAULT '{}'::jsonb,
            
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        
        -- Index for JSONB queries on KPIs
        CREATE INDEX IF NOT EXISTS idx_reports_kpis ON reports USING GIN (kpis);
        
        -- Store raw LLM responses for each unique combination
        CREATE TABLE IF NOT EXISTS llm_responses (
            id SERIAL PRIMARY KEY,
            report_id INTEGER NOT NULL REFERENCES reports(id) ON DELETE CASCADE,
            prompt_template TEXT NOT NULL,
            region VARCHAR(100) NOT NULL,
            language_code VARCHAR(10) NOT NULL,
            keyword VARCHAR(255) NOT NULL,
            model VARCHAR(255) NOT NULL,
            prompt_text TEXT NOT NULL,
            response TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        
        CREATE INDEX IF NOT EXISTS idx_llm_responses_report ON llm_responses(report_id);
        CREATE INDEX IF NOT EXISTS idx_llm_responses_language ON llm_responses(language_code);
        CREATE INDEX IF NOT EXISTS idx_llm_responses_keyword ON llm_responses(keyword);
        
        -- Grant permissions to geometrics user
        GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO geometrics;
        GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO geometrics;


# Read replicas (disabled for now)
readReplicas:
  enabled: false

# Service settings
service:
  type: ClusterIP
  ports:
    postgresql: 5432

# Network policy (restrict access to same namespace)
networkPolicy:
  enabled: true
  allowExternal: false

# Metrics exporter (optional - enable for monitoring)
metrics:
  enabled: false
  serviceMonitor:
    enabled: false

# Volume permissions init container
volumePermissions:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 100m
      memory: 128Mi

# Security context
containerSecurityContext:
  enabled: true
  runAsUser: 1001
  runAsNonRoot: true

podSecurityContext:
  enabled: true
  fsGroup: 1001